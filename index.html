<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        #editor-root {
            border: 1px solid #ccc;
            padding: 1rem;
        }
        #editor-console {
            font-family: monospace;
            border: 1px solid gold;
            list-style: none;
            li {
                border: 1px solid black;
                border-width: 1px 0 0 0;
                padding: 0.5rem;
                &.error {
                    color: red;
                }
            }
            overflow: auto;
            max-height: 20rem;
            height: 15rem;
        }
        #editor-content {
            /*height: 15rem;*/
        }
        .hbox, .vbox {
            border: 1px solid red;
            display: flex;
        }
        .hbox {
            flex-direction: row;
        }
        .vbox {
            flex-direction: column;
            max-height: 10rem;
            min-width: 10rem;
        }
        .scroll {
            overflow: scroll;
        }
        ul {
            border: 1px solid red;
            list-style: none;
            margin: 0;
            padding: 0;
            li {
                padding: 0.25rem 0.5rem;
                background-color: #fff;
                &:hover {
                    background-color: #cccccc;
                }
                &.selected {
                    background-color: mediumaquamarine;
                }
                &.selected:hover {
                    background-color: aquamarine;
                }
            }
        }
        .source {
            font-family: monospace;
            white-space: pre;
            padding: 0.5rem;
            overflow: scroll;
            max-height: 10rem;
        }
    </style>

    <style>
        .cm-scroller {
            overflow: auto;
        }
        .cm-editor {
            height: 25rem;
            width: 100%;
            border: 1px solid black;
        }
    </style>
</head>
<body>

<h1>Smalltalk Browser Demo</h1>

<div id="editor-codemirror"></div>

<script type="module">
</script>


<nav>

<script type="application/smalltalk" id="arithmetic-code">
6+7
</script>
<button class="example" id="arithmetic">arithmetic</button>

<script type="application/smalltalk" id="for-loop-code">
1 range: 5 do: [i|
    Debug print: "number " + i.
].
</script>
<button class="example" id="for-loop">for loop</button>

<script type="application/smalltalk" id="point-code">
Point := (Object clone).
Point make_data_slot: "x" with: 0.
Point make_data_slot: "y" with: 0.

Point makeSlot: "x:y:" with: [x y |
   pt := Point clone.
   pt x: x.
   pt y: y.
   pt.
].

Point makeSlot: "print" with: [ "Point (" + self x + "," + self y + ")" ].

Point makeSlot: "+" with: [pt |
   new := Point clone.
   new x: (self x) + (pt x).
   new y: (self y) + (pt y).
   new.
].

pt := Point x: 1 y: 1.

pt2 := Point x: 2 y: 2.

pt3 := pt + pt2.
Debug print: pt3 print.
</script>
<button class="example" id="point">point</button>

<script type="application/smalltalk" id="advent1-code">
self makeSlot: "filterGifts:" with: [ gifts |
    gifts select: [g | (g contains: "#") not ].
].
self filterGifts: { "car" "doll#arm" "ball" "#train" }.
</script>
<button class="example" id="advent1">advent 1</button>

<script type="application/smalltalk" id="advent2-code">
self makeSlot: "manufactureGifts:" with: [ gifts |
    output := List clone.
    gifts do: [ gift |
        (gift at: "quantity") times: [ q |
            output add: (gift at: "toy").
        ].
   ].
   output.
].


production1 := {
    { toy: 'car'   quantity: 3 }
    { toy: 'doll'  quantity: 1 }
    { toy: 'ball'  quantity: 2 }
}.
self manufactureGifts: production1.
</script>
<button class="example" id="advent2">advent 2</button>

<script type="application/smalltalk" id="advent3-code">
self makeSlot: "drawGift:symbol:" with: [size symbol |
    (size < 1) ifTrue: [^""].
    output := "".
    output := output + (symbol repeat: size).
    output := output + "\n".

    1 range: size-1 do: [i |
        output := output + symbol.
        output := " " repeat: size-2.
        output := output + symbol.
        output := output + "\n".
    ].

    output := output + (symbol repeat: size).
    ^ output.
].

self drawGift: 4 symbol: "*".
</script>
<button class="example" id="advent3">advent 3</button>
</nav>

<button id="execute">doit</button>
<p>cmd-shift-enter to evaluate selection</p>

<script type="module">
    import {JoshLogger} from "./src/util.ts";
    import {make_browser_scope} from "./src/browser.ts";
    import {
        crosshairCursor,
        drawSelection, dropCursor,
        EditorView, highlightActiveLine,
        highlightActiveLineGutter,
        highlightSpecialChars,
        keymap,
        lineNumbers, rectangularSelection
    } from "@codemirror/view"
    import {basicSetup} from "codemirror"
    import {Smalltalk, SmalltalkLanguage} from "codemirror-lang-smalltalk"
    import {
        bracketMatching, defaultHighlightStyle,
        foldGutter,
        foldKeymap,
        indentOnInput,
        indentUnit,
        syntaxHighlighting
    } from "@codemirror/language";
    import {autocompletion, closeBrackets, closeBracketsKeymap, completionKeymap} from "@codemirror/autocomplete"
    import {defaultKeymap, history, indentWithTab} from "@codemirror/commands"
    import {bval} from "./src/bytecode.ts";

    let scope = make_browser_scope(document);

    const $ = (sel) => document.querySelector(sel)
    const $$ = (sel) => document.querySelectorAll(sel)
    const on = (el,type,cb) => el.addEventListener(type,cb)
    const d = new JoshLogger()

    function output(out) {
        const li = document.createElement('li')
        if (Error.isError(out)) {
            li.innerText = out.message
            li.classList.add('error')
        } else if(out.is_kind_of('NumberProto')) {
            li.innerText = "Number: " + out._get_js_number()
            li.classList.add('number')
        } else if(out.is_kind_of('StringProto')) {
            li.innerText = "String: " + out._get_js_string()
            li.classList.add('string')
        } else {
            li.innerText = "Object: " + out.print()
            li.classList.add('object')
        }
        const cons = $("#editor-console")
        cons.append(li)
        cons.scrollTop = cons.scrollHeight

    }
    function eval_it(code, scope) {
        d.disable()
        d.p('=========')
        d.p(`code is '${code}'`)
        try {
            let ret = bval(code,scope)
            d.p("returned", ret)
            output(ret)
        } catch (e) {
            console.log("error happened",e.name, e.type,e.message)
            output(e)
        }
    }

    bval(`
        dom := DomProxy clone.
        dom init.
        Global makeSlot: "dom" with: dom.
    `,scope)

    // fetch('./examples/classbrowser.st').then(r => r.text()).then(txt => eval_statements(txt, scope))


    const eval_selection = (view) => {
        const selectedText = view.state.selection.ranges
            .map(range => view.state.doc.sliceString(range.from, range.to))
            .join("\n");
        eval_it(selectedText, scope)
        return true
    }
    const custom_keymap = keymap.of([
        {
            key: "Cmd-Enter",
            run: eval_selection
        },
        {
            key: "Cmd-Shift-Enter",
            run: eval_selection
        }
    ])

    const common_methods = [
        "print",
        "make_data_slot:",
        "makeSlot:",
        "clone",
        "Debug",
    ]
    function myCompletions(context) {
        let word = context.matchBefore(/\w*/)
        if (word.from == word.to && !context.explicit) {
            return null
        }
        console.log(word)
        let opts = common_methods.map(m => {
            return {label:m, type:"keyword", info: "Method"}
        })
        return {
            from: word.from,
            options:opts,
        }
    }

    const fooCompletions = SmalltalkLanguage.data.of({
        autocomplete:myCompletions
    })
    const view = new EditorView({
        doc: `6 + 7`,
        parent: document.getElementById('editor-codemirror'),
        extensions: [
            lineNumbers(), // line numbers in the gutter
            highlightActiveLineGutter(), // highlights the active line in the gutter
            highlightSpecialChars(),
            foldGutter(), // creates gutter icons for folding
            drawSelection(),
            dropCursor(),
            indentOnInput(),
            syntaxHighlighting(defaultHighlightStyle, { fallback: true }),
            bracketMatching(), // highlights matching brackets when the cursor is on them
            closeBrackets(), // generate closing bracket when typing the opening bracket
            autocompletion(), // ??
            rectangularSelection(),
            crosshairCursor(),
            highlightActiveLine(),
            history(),
            fooCompletions,
            custom_keymap,
            keymap.of([
                ...closeBracketsKeymap,
                ...defaultKeymap,
                // ...searchKeymap,
                // ...historyKeymap,
                ...foldKeymap,
                ...completionKeymap,
                // ...lintKeymap
                indentWithTab,
            ]),
            indentUnit.of('    '), // sent a really big indent
            // tie, dress, ski hat
            // basicSetup,
            Smalltalk(),
            // javascript({typescript:true}),
        ]
    })

    $$(".example").forEach(ex => {
        console.log("example",ex)
        on(ex,'click',() => {
            let code = $(`#${ex.id}-code`).innerText
            console.log("using code",code)
            // replace the contents of the document
            view.dispatch({
                changes: {
                    from: 0,
                    to: view.state.doc.length,
                    insert: code.trim(),//"entirely new document"
                }
            });

            // select the entire document
            view.dispatch({
                selection: {
                    anchor: 0,
                    head: view.state.doc.length
                }
            })
        })
    })
    on($("#execute"),'click',() => {
        const selectedText = view.state.selection.ranges
            .map(range =>
                view.state.doc.sliceString(range.from, range.to)
            )
            .join("\n");
        console.log("selectedText", selectedText);
        eval_it(selectedText, scope)
    })
</script>
</body>
</html>